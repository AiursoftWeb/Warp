@model Aiursoft.Warp.Models.HomeViewModels.IndexViewModel

<div class="row mb-2 mb-xl-3">
    <div class="col-auto d-none d-sm-block">
        <h3>@Localizer["Link Shorter"]</h3>
    </div>
    <div class="col-auto ms-auto text-end mt-n1">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb bg-transparent p-0 mt-1 mb-0">
                <li class="breadcrumb-item"><a href="#">AppStack</a></li>
                <li class="breadcrumb-item"><a href="#">Tools</a></li>
                <li class="breadcrumb-item active" aria-current="page">Shorter</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-12 col-xl-10">

        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">@Localizer["Create New Link"]</h5>
            </div>
            <div class="card-body">
                <form id="createLinkForm" asp-action="Index" method="post" autocomplete="off">

                    @if (!string.IsNullOrEmpty(Model.CreatedShortLink))
                    {
                        <div class="alert alert-success alert-dismissible fade show mb-4" role="alert" id="success-alert">
                            <div class="alert-message">
                                <h4 class="alert-heading"><i class="align-middle me-2" data-lucide="check-circle"></i>@Localizer["Success!"]</h4>
                                <p>@Localizer["Your short link has been created:"]</p>
                                <div class="input-group mt-2">
                                    <input type="text" class="form-control" value="@Model.CreatedShortLink" id="short-link-output" readonly>
                                    <button class="btn btn-primary" type="button" id="copy-button" title="@Localizer["Copy to clipboard"]">
                                        <i class="align-middle" data-lucide="copy"></i> @Localizer["Copy"]
                                    </button>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    <div class="mb-3">
                        <label class="form-label" for="TargetUrl">@Localizer["Target URL"] <span class="text-danger">*</span></label>
                        <input id="TargetUrl" name="TargetUrl" type="url" class="form-control form-control-lg" placeholder="https://example.com/..." required asp-for="TargetUrl" />
                        <div class="form-text text-muted">@Localizer["Please enter the complete URL, e.g.:"] <code>https://example.com/path</code></div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="CustomCode">@Localizer["Custom Code"]</label>
                            <input id="CustomCode" asp-for="CustomCode" name="CustomCode" class="form-control" type="text" placeholder="@Localizer["e.g.: my-product"]" />
                            <span asp-validation-for="CustomCode" class="text-danger small"></span>
                            <div class="form-text text-muted">@Localizer["Leave empty to auto-generate."]</div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="title">@Localizer["Title / Remark"]</label>
                            <input id="title" asp-for="Title" name="title" class="form-control" type="text" placeholder="@Localizer["e.g.: Double Eleven Campaign"]" />
                            <div class="form-text text-muted">@Localizer["For internal identification only."]</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="ExpireAt">@Localizer["Expiration Time"]</label>
                            <input id="ExpireAt" asp-for="ExpireAt" name="ExpireAt" class="form-control" type="datetime-local" />
                            <div class="form-text text-muted">@Localizer["Optional. Leave empty for permanent."]</div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="MaxClicks">@Localizer["Max Clicks"]</label>
                            <input id="MaxClicks" asp-for="MaxClicks" name="MaxClicks" class="form-control" type="number" min="1" placeholder="@Localizer["e.g.: 100"]" />
                            <div class="form-text text-muted">@Localizer["Link expires after reaching this limit."]</div>
                        </div>
                    </div>

                    <hr class="my-4" />

                    <div class="mb-3">
                        <label class="form-label">@Localizer["Privacy Settings"]</label>

                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="IsPrivate" asp-for="IsPrivate" name="IsPrivate">
                            <label class="form-check-label" for="IsPrivate">@Localizer["Make this link Private"]</label>
                        </div>
                        <div class="form-text text-muted">@Localizer["Private links require a password to access."]</div>

                        <input id="visibility" name="visibility" type="hidden" value="public" />
                    </div>

                    <div class="mb-3 d-none" id="passwordField">
                        <label class="form-label" for="password">@Localizer["Access Password"] <span class="text-danger">*</span></label>
                        <input id="password" asp-for="Password" name="password" class="form-control" type="password" placeholder="@Localizer["Enter access password"]" />
                        <div class="form-text text-muted">@Localizer["The server will encrypt and store the password safely."]</div>
                    </div>

                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="align-middle me-1" data-lucide="link"></i> @Localizer["Create Short Link"]
                        </button>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>

@* ReSharper disable once Razor.SectionNotResolved *@
@section scripts {
    <script>
        (function () {
            const privateCheckbox = document.getElementById('IsPrivate');
            const visibilityHidden = document.getElementById('visibility');
            const passwordField = document.getElementById('passwordField');
            const passwordInput = document.getElementById('password');

            function updateVisibilityUI() {
                if (privateCheckbox.checked) {
                    visibilityHidden.value = 'private';
                    // Bootstrap 5 使用 d-none 来控制显示隐藏，而不是 hidden class
                    passwordField.classList.remove('d-none');
                    // 聚焦体验优化
                    // passwordInput.focus();
                } else {
                    visibilityHidden.value = 'public';
                    passwordField.classList.add('d-none');
                    passwordInput.value = '';
                }
            }

            // 初始化
            updateVisibilityUI();

            // 监听复选框变化
            privateCheckbox.addEventListener('change', updateVisibilityUI);

            // 客户端基础验证
            document.getElementById('createLinkForm').addEventListener('submit', function (e) {
                if (visibilityHidden.value === 'private') {
                    const pwd = passwordInput.value.trim();
                    if (!pwd) {
                        e.preventDefault();
                        // 这里可以用 Bootstrap 的 toast 或者 invalid-feedback，简单起见保留 alert
                        alert('@Localizer["This link is private, please enter the access password."]');
                        passwordInput.focus();
                    }
                }
            });

            const copyButton = document.getElementById('copy-button');
            if (copyButton) {
                copyButton.addEventListener('click', function () {
                    const linkInput = document.getElementById('short-link-output');
                    linkInput.select();
                    document.execCommand('copy');

                    // Visual feedback
                    const originalHtml = copyButton.innerHTML;
                    // 注意：直接修改 innerHTML 可能会丢失 lucide 图标的 SVG 渲染，
                    // 如果你的页面引入了 lucide.js，你可能需要调用 lucide.createIcons();
                    // 为了稳妥，这里暂时只改文字，或者你可以保留原文字增加 Copied 状态
                    copyButton.innerHTML = '<span class="align-middle">@Localizer["Copied!"]</span>';
                    copyButton.classList.replace('btn-primary', 'btn-success');

                    setTimeout(() => {
                        copyButton.innerHTML = originalHtml;
                        copyButton.classList.replace('btn-success', 'btn-primary');
                        // 尝试重新渲染图标（如果环境里有这个函数）
                        if (typeof lucide !== 'undefined' && lucide.createIcons) {
                            lucide.createIcons();
                        }
                    }, 2000);
                });
            }
        })();
    </script>
}
