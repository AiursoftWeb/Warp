@using Microsoft.AspNetCore.Authorization
@using Aiursoft.Warp.Authorization
@using Aiursoft.Warp.Services.FileStorage
@model Aiursoft.Warp.Models.AdminViewModels.UserLinksViewModel
@inject IViewLocalizer Localizer
@inject IAuthorizationService AuthorizationService
@inject StorageService StorageService

@{
    var canEditAnyLink = (await AuthorizationService.AuthorizeAsync(User, AppPermissionNames.CanEditAnyLink)).Succeeded;
    var canDeleteAnyLink = (await AuthorizationService.AuthorizeAsync(User, AppPermissionNames.CanDeleteAnyLink)).Succeeded;
}

<div class="row mb-2 mb-xl-3">
    <div class="col-auto d-none d-sm-block">
        <h3>@Localizer["Links by"] @Model.User.DisplayName</h3>
    </div>
    <div class="col-auto ms-auto text-end mt-n1">
        <a asp-action="AllLinks" class="btn btn-light">
            <i class="align-middle" data-lucide="arrow-left"></i> @Localizer["Back to All Links"]
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-4 col-xl-3">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="card-title mb-0">@Localizer["Profile Details"]</h5>
            </div>
            <div class="card-body text-center">
                <a href="@StorageService.RelativePathToInternetUrl(Model.User.AvatarRelativePath)" target="_blank" rel="noopener noreferrer">
                    <img src="@StorageService.RelativePathToInternetUrl(Model.User.AvatarRelativePath)?w=256&square=true"
                         alt="@Model.User.DisplayName" class="img-fluid rounded-circle mb-2" width="128" height="128"/>
                </a>
                <h5 class="card-title mb-0">@Model.User.DisplayName</h5>
                <div class="text-muted mb-2">@Model.User.Email</div>
            </div>
            <div class="list-group list-group-flush">
                <div class="list-group-item">
                    <div class="row">
                        <strong class="col-sm-6">@Localizer["Username"]</strong>
                        <div class="col-sm-6 text-sm-end">@@@Model.User.UserName</div>
                    </div>
                </div>
                <div class="list-group-item">
                    <div class="row">
                        <strong class="col-sm-6">@Localizer["Total Docs"]</strong>
                        <div class="col-sm-6 text-sm-end">@Model.UserLinks.Count()</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-8 col-xl-9">
        <div class="card flex-fill">
            <div class="card-header">
                <h5 class="card-title mb-0">@Localizer["Link Management"]</h5>
            </div>
            @if (!Model.UserLinks.Any())
            {
                <div class="card-body">
                    <div class="alert alert-info mb-0" role="alert">
                        @Localizer["This user has not created any links yet."]
                    </div>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover my-0" id="links-table">
                        <thead>
                            <tr>
                                <th>@Localizer["Link Info"]</th>
                                <th class="d-none d-xl-table-cell">@Localizer["Target"]</th>
                                <th>@Localizer["Clicks"]</th>
                                <th class="d-none d-md-table-cell">@Localizer["Status"]</th>
                                <th class="text-end">@Localizer["Actions"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.UserLinks)
                            {
                                var isExpired = item.ExpireAt.HasValue && item.ExpireAt.Value < DateTime.UtcNow;
                                var progressPercent = 0;
                                if (item.MaxClicks.HasValue && item.MaxClicks.Value > 0)
                                {
                                    progressPercent = (int)((double)item.Clicks / item.MaxClicks.Value * 100);
                                    if (progressPercent > 100) progressPercent = 100;
                                }
                                var rowHref = canEditAnyLink ? Url.Action("EditLink", new { id = item.Id }) : null;
                                <tr style="cursor: pointer;" data-href="@rowHref">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0">
                                                <div class="bg-body-tertiary rounded-2 p-2">
                                                    @if (item.IsPrivate)
                                                    {
                                                        <i class="align-middle text-warning" data-lucide="lock" title="@Localizer["Private Link"]"></i>
                                                    }
                                                    else
                                                    {
                                                        <i class="align-middle text-primary" data-lucide="globe" title="@Localizer["Public Link"]"></i>
                                                    }
                                                </div>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <div class="fw-bold text-dark">
                                                    @(string.IsNullOrEmpty(item.Title) ? item.RedirectTo : item.Title)
                                                </div>
                                                <div class="small text-muted">
                                                    /r/@item.RedirectTo
                                                    @if (item.IsCustom)
                                                    {
                                                        <span class="badge badge-subtle-info ms-1">Custom</span>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="d-none d-xl-table-cell align-middle">
                                        <div class="d-flex align-items-center" style="max-width: 250px;">
                                            <i class="align-middle me-2 text-muted" data-lucide="arrow-right"></i>
                                            <span class="text-truncate text-muted">@item.TargetUrl</span>
                                        </div>
                                    </td>
                                    <td class="align-middle">
                                        <div class="d-flex flex-column w-100" style="min-width: 100px;">
                                            <div class="d-flex justify-content-between mb-1">
                                                <span class="text-dark fw-bold">@item.Clicks</span>
                                                @if (item.MaxClicks.HasValue)
                                                {
                                                    <span class="text-muted small">/ @item.MaxClicks</span>
                                                }
                                            </div>

                                            @if (item.MaxClicks.HasValue)
                                            {
                                                <div class="progress progress-sm w-100">
                                                    <div class="progress-bar @(progressPercent >= 100 ? "bg-danger" : "bg-success")"
                                                         role="progressbar"
                                                         style="width: @progressPercent%;"></div>
                                                </div>
                                            }
                                        </div>
                                    </td>
                                    <td class="d-none d-md-table-cell align-middle">
                                        @if (isExpired)
                                        {
                                            <span class="badge bg-danger">@Localizer["Expired"]</span>
                                            <div class="small text-muted mt-1">
                                                <label class="text-monospace" data-utc-time="@item.ExpireAt?.ToHtmlDateTime()"></label>
                                            </div>
                                        }
                                        else if (item.ExpireAt.HasValue)
                                        {
                                            <span class="badge bg-success">@Localizer["Active"]</span>
                                            <div class="small text-muted mt-1" title="@Localizer["Expires at"]">
                                                <i class="align-middle" data-lucide="clock" style="width:12px;"></i>
                                                <label class="text-monospace" data-utc-time="@item.ExpireAt.Value.ToHtmlDateTime()"></label>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="badge bg-success">@Localizer["Active"]</span>
                                            <div class="small text-muted mt-1">@Localizer["Permanent"]</div>
                                        }
                                    </td>
                                    <td class="text-end align-middle table-action">
                                        <div class="dropdown position-static" onclick="event.stopPropagation();">
                                            <a href="#" data-bs-toggle="dropdown" data-bs-boundary="viewport">
                                                <i class="align-middle text-muted" data-lucide="more-horizontal"></i>
                                            </a>
                                            <div class="dropdown-menu dropdown-menu-end">
                                                <a class="dropdown-item" href="/r/@item.RedirectTo" target="_blank">
                                                    <i class="align-middle me-1" data-lucide="external-link"></i> @Localizer["Visit Link"]
                                                </a>
                                                @if (canEditAnyLink)
                                                {
                                                    <a class="dropdown-item" asp-action="EditLink" asp-route-id="@item.Id">
                                                        <i class="align-middle me-1" data-lucide="edit-2"></i> @Localizer["Edit"]
                                                    </a>
                                                }
                                                <div class="dropdown-divider"></div>
                                                @if (canDeleteAnyLink)
                                                {
                                                    <a class="dropdown-item text-danger" asp-action="DeleteLink" asp-route-id="@item.Id">
                                                        <i class="align-middle me-1" data-lucide="trash-2"></i> @Localizer["Delete"]
                                                    </a>
                                                }
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@* ReSharper disable once Razor.SectionNotResolved *@
@section scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            const table = document.getElementById('links-table');
            if (table) {
                table.addEventListener('click', function (e) {
                    const row = e.target.closest('tr');
                    if (!row || !row.dataset.href) return;
                    const selection = window.getSelection();
                    if (selection.toString().length > 0) return;

                    const target = e.target;
                    if (!target.matches('a, a *, button, button *, .dropdown, .dropdown *')) {
                         window.location.href = row.dataset.href;
                    }
                });
            }
        });
    </script>
}
